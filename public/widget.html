<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payouts CommunautÃ© Xeilos</title>

  <style>
    :root{
      --bg: rgba(0,0,0,0.60);
      --fg: #ffffff;
      --muted: rgba(255,255,255,0.75);

      /* âœ… barre verte "billet" */
      --bar-bg: rgba(255,255,255,0.15);
      --bar-fill: #2fbf5b;

      --shadow: 0 10px 28px rgba(0,0,0,0.35);
      --radius: 14px;
      --pad: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; background:transparent; overflow:hidden; }
    body{
      font-family: Arial, sans-serif; /* âœ… Arial */
      color: var(--fg);
    }

    /* Container */
    .root{
      width: 900px;
      height: 120px;
      padding: var(--pad);
      background: var(--bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap: 8px;
      position:relative;
      overflow:hidden;
    }

    /* Header */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size: 18px;
      font-weight: 700;
      line-height:1;
      white-space:nowrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .title span{
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Total cumul (gras comme le titre) */
    .total{
      font-weight: 700;
      opacity: 0.95;
      font-size: 16px;
    }

    /* Progress line */
    .mid{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .label{
      font-size: 14px;
      color: var(--muted);
      min-width: 140px;
      white-space:nowrap;
    }

    .bar{
      flex: 1;
      height: 10px;
      background: var(--bar-bg);
      border-radius: 999px;
      overflow:hidden;
      position:relative;
    }
    .fill{
      height:100%;
      width: 0%;
      background: var(--bar-fill);
      border-radius: 999px;
      transition: width 600ms ease;
    }

    /* Footer */
    .bottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .last{
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .err{
      display:none;
      color:#ffb0b0;
      font-size: 12px;
      white-space:nowrap;
    }

    /* ===== pluie de billets (6s) ===== */
    .rain{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      display:none;
    }
    .rain.show{ display:block; }

    .bill{
      position:absolute;
      top:-40px;
      width: 46px;
      height: 26px;
      border-radius: 6px;
      background: linear-gradient(135deg, rgba(47,191,91,0.95), rgba(170,255,200,0.85));
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      opacity: 0.95;
      transform: rotate(0deg);
      animation: fall 6s linear forwards;
    }
    .bill::after{
      content:"$";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: rgba(0,0,0,0.35);
      font-size: 16px;
    }

    @keyframes fall{
      0%   { transform: translateY(-40px) rotate(0deg); opacity: 0; }
      10%  { opacity: 0.95; }
      100% { transform: translateY(200px) rotate(360deg); opacity: 0; }
    }
  </style>
</head>

<body>
  <div class="root" id="root">
    <div class="rain" id="rain"></div>

    <div class="top">
      <div class="title">
        ðŸ’° <span>Payouts CommunautÃ© Xeilos</span>
      </div>

      <div class="total" id="totalCumul">Total cumul : $0</div>
    </div>

    <div class="mid">
      <div class="label" id="cycleLabel">$0 / $100,000</div>
      <div class="bar"><div class="fill" id="fill"></div></div>
    </div>

    <div class="bottom">
      <div class="last" id="lastLine">Dernier payout : â€”</div>
      <div class="err" id="err">Hors ligne âœ–</div>
    </div>
  </div>

  <!-- âœ… Sons -->
  <audio id="sndPayout" preload="auto" src="./cash.mp3"></audio>
  <!-- âš ï¸ ajoute milestone.mp3 dans /public/ (sinon fallback automatique) -->
  <audio id="sndMilestone" preload="auto" src="./milestone.mp3"></audio>

  <script>
    const API_URL = "/payouts";
    const STEP_FALLBACK = 100000;

    const fill = document.getElementById("fill");
    const cycleLabel = document.getElementById("cycleLabel");
    const totalCumul = document.getElementById("totalCumul");
    const lastLine = document.getElementById("lastLine");
    const err = document.getElementById("err");

    const sndPayout = document.getElementById("sndPayout");
    const sndMilestone = document.getElementById("sndMilestone");

    const rain = document.getElementById("rain");

    function money(n){
      const x = Number(n || 0);
      return "$" + x.toLocaleString("en-US");
    }

    function safePlay(audioEl){
      if (!audioEl) return;
      try{
        audioEl.currentTime = 0;
        const p = audioEl.play();
        if (p && typeof p.catch === "function") p.catch(()=>{});
      }catch(e){}
    }

    // fallback: si milestone.mp3 n'existe pas, on rejoue cash.mp3
    sndMilestone.addEventListener("error", () => {
      sndMilestone.src = "./cash.mp3";
    });

    function startRainBills(durationMs = 6000){
      // reset
      rain.innerHTML = "";
      rain.classList.add("show");

      // crÃ©er ~35 billets
      const count = 35;
      for (let i=0;i<count;i++){
        const b = document.createElement("div");
        b.className = "bill";
        const left = Math.random() * 100;
        const delay = Math.random() * 0.8; // lÃ©ger Ã©talement
        const scale = 0.75 + Math.random() * 0.6;

        b.style.left = left + "%";
        b.style.animationDelay = delay + "s";
        b.style.transform = `rotate(${Math.random()*180-90}deg) scale(${scale})`;

        rain.appendChild(b);
      }

      setTimeout(() => {
        rain.classList.remove("show");
        rain.innerHTML = "";
      }, durationMs);
    }

    // Pour dÃ©tecter un nouveau payout (donc nouvelle rÃ©action âœ…)
    // On se base sur lastAt (timestamp) renvoyÃ© par l'API.
    let lastSeenAt = Number(localStorage.getItem("xeilos_lastAt") || 0);

    async function refresh(){
      try{
        const res = await fetch(API_URL, { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        err.style.display = "none";

        const total = Number(data.total || 0);
        const step = Number(data.step || STEP_FALLBACK);
        const lastPayout = Number(data.lastPayout || 0);
        const lastAt = Number(data.lastAt || 0);

        // cycle: on affiche l'avancement dans le cycle actuel
        const inStep = total % step;
        const pct = Math.max(0, Math.min(100, (inStep / step) * 100));

        fill.style.width = pct.toFixed(2) + "%";
        cycleLabel.textContent = `${money(inStep)} / ${money(step)}`;
        totalCumul.textContent = `Total cumul : ${money(total)}`;

        // âœ… plus de pseudo, seulement montant
        lastLine.textContent = lastPayout > 0 ? `Dernier payout : ${money(lastPayout)}` : "Dernier payout : â€”";

        // ðŸ”Š nouveau payout = son
        const isNewPayout = lastAt > 0 && lastAt !== lastSeenAt;
        if (isNewPayout){
          // Si palier 100k touchÃ©, son spÃ©cial + pluie billets 6s
          if (data.milestoneJustHit){
            safePlay(sndMilestone);
            startRainBills(6000);
          } else {
            safePlay(sndPayout);
          }

          lastSeenAt = lastAt;
          localStorage.setItem("xeilos_lastAt", String(lastSeenAt));
        }

      }catch(e){
        err.style.display = "block";
      }
    }

    refresh();
    setInterval(refresh, 2000);
  </script>
</body>
</html>
