<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payouts CommunautÃ© Xeilos</title>

  <style>
    :root{
      --bg: rgba(0,0,0,0.60);
      --fg: #ffffff;
      --muted: rgba(255,255,255,0.75);

      --bar-bg: rgba(255,255,255,0.15);
      --bar-fill: #C63B3B; /* âœ… ton rouge Xeilos pour la barre */
      --shadow: 0 10px 30px rgba(0,0,0,0.35);

      --radius: 14px;
      --pad: 14px;

      --step: 100000; /* fallback si lâ€™API ne renvoie pas step */
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; background:transparent; }
    body{
      font-family: Arial, sans-serif; /* âœ… Arial */
      color: var(--fg);
      overflow:hidden;
    }

    /* Container */
    .root{
      width: 800px;
      height: 120px;
      padding: var(--pad);
      background: var(--bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    /* Header row */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      font-weight: 700;
      font-size: 18px;
      line-height: 1;
      letter-spacing: 0.2px;
      white-space:nowrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .title span{
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* âœ… On supprime "En ligne" : pas dâ€™Ã©lÃ©ment status affichÃ© */
    .right{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
      white-space:nowrap;
    }

    /* Progress numbers */
    .numbers{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size: 14px;
      color: var(--muted);
      white-space:nowrap;
      gap: 10px;
    }

    .numbers .left{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }
    .numbers .left b{
      color: var(--fg);
      font-weight: 800;
    }
    .numbers .right{
      color: var(--muted);
      font-weight: 700;
    }

    /* Progress bar */
    .bar{
      width:100%;
      height: 10px;
      background: var(--bar-bg);
      border-radius: 999px;
      overflow:hidden;
      position: relative;
    }
    .fill{
      height: 100%;
      width: 0%;
      background: var(--bar-fill);
      border-radius: 999px;
      transition: width 700ms ease;
    }

    /* Footer */
    .bottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size: 13px;
      color: var(--muted);
      white-space:nowrap;
      gap: 10px;
    }
    .bottom .last{
      overflow:hidden;
      text-overflow:ellipsis;
      min-width: 0;
    }

    /* Error */
    .error{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      color:#fff;
      background: rgba(0,0,0,0.7);
      border-radius: var(--radius);
      font-weight: 800;
      letter-spacing: 0.3px;
    }

    /* ===============================
       ðŸŽ† ANIMATION XEILOS 6s (100k)
       =============================== */

    .milestoneLayer{
      pointer-events:none;
      position:absolute;
      inset:0;
      overflow:hidden;
      border-radius: var(--radius);
      display:none;
    }

    .root.milestoneHit .milestoneLayer{
      display:block;
    }

    /* glow + pulse */
    .root.milestoneHit{
      animation: xeilosPulse 6s ease-in-out 1;
    }

    @keyframes xeilosPulse{
      0%   { box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
      8%   { box-shadow: 0 10px 45px rgba(198,59,59,0.55); }
      20%  { box-shadow: 0 10px 55px rgba(198,59,59,0.65); }
      40%  { box-shadow: 0 10px 45px rgba(198,59,59,0.55); }
      100% { box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    }

    /* burst text */
    .burst{
      position:absolute;
      left: 18px;
      top: 44px;
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 0.5px;
      color: #fff;
      text-shadow: 0 8px 25px rgba(0,0,0,0.45);
      opacity: 0;
      transform: translateY(8px) scale(0.98);
      animation: burstIn 6s ease-in-out 1;
    }
    @keyframes burstIn{
      0%   { opacity:0; transform: translateY(10px) scale(0.98); }
      8%   { opacity:1; transform: translateY(0) scale(1.00); }
      25%  { opacity:1; }
      70%  { opacity:1; }
      100% { opacity:0; transform: translateY(-6px) scale(1.01); }
    }

    /* money particles */
    .bill{
      position:absolute;
      width: 18px;
      height: 10px;
      border-radius: 2px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      opacity: 0;
      transform: translateY(0) rotate(0deg);
      animation: fly 6s ease-in-out 1;
    }

    /* Variation via CSS custom properties */
    @keyframes fly{
      0%   { opacity:0; transform: translate(var(--x0), var(--y0)) rotate(var(--r0)); }
      10%  { opacity:1; }
      60%  { opacity:1; }
      100% { opacity:0; transform: translate(var(--x1), var(--y1)) rotate(var(--r1)); }
    }

    /* subtle red overlay */
    .redwash{
      position:absolute;
      inset:-20%;
      background: radial-gradient(circle at 20% 30%, rgba(198,59,59,0.30), transparent 55%),
                  radial-gradient(circle at 80% 20%, rgba(198,59,59,0.22), transparent 55%),
                  radial-gradient(circle at 70% 85%, rgba(198,59,59,0.18), transparent 55%);
      opacity: 0;
      animation: wash 6s ease-in-out 1;
    }
    @keyframes wash{
      0%{opacity:0}
      10%{opacity:1}
      80%{opacity:1}
      100%{opacity:0}
    }
  </style>
</head>

<body>
  <div id="root" class="root">
    <!-- layer for milestone animation -->
    <div class="milestoneLayer" id="milestoneLayer">
      <div class="redwash"></div>
      <div class="burst">ðŸ’° 100K ATTEINT !</div>

      <!-- Bills (positions auto via CSS vars) -->
      <div class="bill" style="--x0: 120px; --y0: 130px; --r0: 10deg; --x1: 40px;  --y1: -60px; --r1: -60deg;"></div>
      <div class="bill" style="--x0: 220px; --y0: 140px; --r0: -15deg; --x1: 260px; --y1: -70px; --r1: 80deg;"></div>
      <div class="bill" style="--x0: 340px; --y0: 150px; --r0: 25deg; --x1: 420px; --y1: -80px; --r1: -90deg;"></div>
      <div class="bill" style="--x0: 520px; --y0: 140px; --r0: -5deg;  --x1: 640px; --y1: -60px; --r1: 70deg;"></div>
      <div class="bill" style="--x0: 650px; --y0: 150px; --r0: 18deg; --x1: 760px; --y1: -90px; --r1: -100deg;"></div>
      <div class="bill" style="--x0: 80px;  --y0: 150px; --r0: -20deg; --x1: 140px; --y1: -90px; --r1: 120deg;"></div>
      <div class="bill" style="--x0: 420px; --y0: 150px; --r0: 40deg; --x1: 360px; --y1: -95px; --r1: -120deg;"></div>
      <div class="bill" style="--x0: 730px; --y0: 130px; --r0: -35deg;--x1: 620px; --y1: -70px; --r1: 140deg;"></div>
    </div>

    <div class="top">
      <div class="title">
        <span>ðŸ’° Payouts CommunautÃ© Xeilos</span>
      </div>

      <!-- âœ… pas de â€œEn ligneâ€ ici -->
      <div class="right" id="totalCumul">Total cumul : $0</div>
    </div>

    <div class="numbers">
      <div class="left">
        <b id="currentInStep">$0</b>
        <span>/</span>
        <span id="targetInStep">$100,000</span>
      </div>
      <div class="right" id="cycleInfo"></div>
    </div>

    <div class="bar">
      <div id="fill" class="fill"></div>
    </div>

    <div class="bottom">
      <div class="last" id="lastLine">Dernier payout : â€”</div>
      <div id="timeAgo">â€”</div>
    </div>

    <div class="error" id="err">Erreur de connexion API</div>
  </div>

  <!-- âœ… Audio milestone -->
  <audio id="milestoneSound" src="/cash.mp3" preload="auto"></audio>

  <script>
    // âœ… Important : lâ€™URL de lâ€™API (mÃªme domaine Railway)
    const API_URL = "/payouts";

    const root = document.getElementById("root");
    const elFill = document.getElementById("fill");
    const elCurrent = document.getElementById("currentInStep");
    const elTarget = document.getElementById("targetInStep");
    const elLast = document.getElementById("lastLine");
    const elAgo = document.getElementById("timeAgo");
    const elErr = document.getElementById("err");
    const elTotalCumul = document.getElementById("totalCumul");
    const elCycleInfo = document.getElementById("cycleInfo");

    function fmtUSD(n){
      const v = Number(n || 0);
      return "$" + v.toLocaleString("en-US");
    }

    function timeAgo(ts){
      const t = Number(ts || 0);
      if (!t) return "â€”";
      const diff = Date.now() - t;
      if (diff < 0) return "â€”";
      const s = Math.floor(diff / 1000);
      if (s < 10) return "Ã  lâ€™instant";
      if (s < 60) return `il y a ${s}s`;
      const m = Math.floor(s / 60);
      if (m < 60) return `il y a ${m} min`;
      const h = Math.floor(m / 60);
      if (h < 24) return `il y a ${h}h`;
      const d = Math.floor(h / 24);
      return `il y a ${d}j`;
    }

    async function refresh(){
      try{
        const res = await fetch(API_URL, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        elErr.style.display = "none";

        const total = Number(data.total || 0);
        const step = Number(data.step || 100000);

        // âœ… total cumulÃ©
        elTotalCumul.textContent = "Total cumul : " + fmtUSD(total);

        // âœ… cycle / reset visuel par palier
        const cycleIndex = Math.floor(total / step);         // 0 => 0-99,999 ; 1 => 100k-199,999 ...
        const inStep = total % step;                         // ce quâ€™on affiche dans la barre
        const pct = Math.max(0, Math.min(100, (inStep / step) * 100));

        elCurrent.textContent = fmtUSD(inStep);
        elTarget.textContent = fmtUSD(step);

        // Info cycle (optionnel, discret)
        if (cycleIndex > 0) {
          elCycleInfo.textContent = `Cycle ${cycleIndex + 1}`;
        } else {
          elCycleInfo.textContent = "";
        }

        elFill.style.width = pct.toFixed(2) + "%";

        // âœ… dernier payout
        const lp = Number(data.lastPayout || 0);
        const who = (data.lastStudent || "").trim();
        if(lp > 0){
          elLast.textContent = `Dernier payout : ${fmtUSD(lp)}${who ? " â€¢ " + who : ""}`;
        } else {
          elLast.textContent = "Dernier payout : â€”";
        }

        elAgo.textContent = timeAgo(data.lastAt);

        // âœ… milestone hit : animation 6s + son
        if (data.milestoneJustHit) {
          root.classList.add("milestoneHit");

          const sound = document.getElementById("milestoneSound");
          if (sound) {
            sound.currentTime = 0;
            sound.volume = 0.8;
            sound.play().catch(() => {});
          }

          setTimeout(() => {
            root.classList.remove("milestoneHit");
          }, 6000);
        }

      }catch(e){
        elErr.style.display = "flex";
      }
    }

    // refresh rapide au lancement + toutes les 5s
    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
