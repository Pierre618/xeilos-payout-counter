<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payouts Communaut√© Xeilos</title>
    <style>
      :root {
        --bg: rgba(0,0,0,0.55);
        --bg2: rgba(0,0,0,0.35);
        --text: rgba(255,255,255,0.92);
        --muted: rgba(255,255,255,0.70);
        --ok: rgba(80, 200, 120, 1);
        --err: rgba(255, 90, 90, 1);
        --bar: rgba(255,255,255,0.22);
        --fill: rgba(255,255,255,0.90);
      }

      body {
        margin: 0;
        background: rgba(0,0,0,0);
        font-family: Arial, Helvetica, sans-serif;
      }

      .root {
        width: 800px;
        padding: 14px 16px;
        border-radius: 10px;
        background: var(--bg);
        color: var(--text);
        box-sizing: border-box;
      }

      .title {
        font-weight: 700;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        text-shadow: 0 1px 0 rgba(0,0,0,0.25);
      }

      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .numbers {
        font-size: 14px;
        color: var(--muted);
        white-space: nowrap;
      }

      .status {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }

      .bar {
        position: relative;
        width: 100%;
        height: 10px;
        background: var(--bar);
        border-radius: 999px;
        overflow: hidden;
        margin-top: 10px;
      }

      .fill {
        height: 100%;
        width: 0%;
        background: var(--fill);
        border-radius: 999px;
        transition: width 0.4s ease;
      }

      .meta {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .err {
        margin-top: 8px;
        font-size: 12px;
        color: var(--err);
        display: none;
      }

      /* animation quand milestone hit */
      .milestoneHit {
        animation: pulse 2.5s ease-in-out 1;
      }
      @keyframes pulse {
        0% { box-shadow: 0 0 0 rgba(255,255,255,0.0); }
        30% { box-shadow: 0 0 25px rgba(255,255,255,0.25); }
        100% { box-shadow: 0 0 0 rgba(255,255,255,0.0); }
      }
    </style>
  </head>

  <body>
    <div id="root" class="root">
      <div class="title">üí∞ Payouts Communaut√© Xeilos</div>

      <div class="row">
        <div class="numbers">
          <span id="current">$0</span> / <span id="target">$100,000</span>
        </div>
        <div id="status" class="status">Mise √† jour‚Ä¶</div>
      </div>

      <div class="bar">
        <div id="fill" class="fill"></div>
      </div>

      <div class="meta">
        <div id="last">Dernier payout : ‚Äî</div>
        <div id="when">‚Äî</div>
      </div>

      <div id="err" class="err">Erreur de connexion API</div>
    </div>

    <script>
      // IMPORTANT: le widget appelle /payouts sur le m√™me domaine Railway
      const API_URL = "/payouts";

      const root = document.getElementById("root");
      const elCurrent = document.getElementById("current");
      const elTarget = document.getElementById("target");
      const elFill = document.getElementById("fill");
      const elStatus = document.getElementById("status");
      const elLast = document.getElementById("last");
      const elWhen = document.getElementById("when");
      const elErr = document.getElementById("err");

      function fmtUSD(n) {
        return "$" + Number(n || 0).toLocaleString("en-US");
      }

      function timeAgo(ts) {
        if (!ts) return "‚Äî";
        const diff = Date.now() - ts;
        const s = Math.floor(diff / 1000);
        if (s < 10) return "√† l‚Äôinstant";
        if (s < 60) return `il y a ${s}s`;
        const m = Math.floor(s / 60);
        if (m < 60) return `il y a ${m} min`;
        const h = Math.floor(m / 60);
        if (h < 24) return `il y a ${h}h`;
        const d = Math.floor(h / 24);
        return `il y a ${d}j`;
      }

      async function refresh() {
        try {
          elStatus.textContent = "Mise √† jour‚Ä¶";
          const res = await fetch(API_URL, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();

          const total = Number(data.total || 0);
          const step = Number(data.step || 100000);
          const instep = total % step;
          const pct = Math.max(0, Math.min(100, (instep / step) * 100));

          elCurrent.textContent = fmtUSD(instep);
          elTarget.textContent = fmtUSD(step);
          elFill.style.width = pct.toFixed(2) + "%";

          const lp = Number(data.lastPayout || 0);
          const ls = (data.lastStudent || "").trim();
          if (lp > 0) {
            elLast.textContent = `Dernier payout : ${fmtUSD(lp)}${ls ? " ‚Ä¢ " + ls : ""}`;
          } else {
            elLast.textContent = "Dernier payout : ‚Äî";
          }

          elWhen.textContent = data.lastAt ? timeAgo(Number(data.lastAt)) : "‚Äî";

          elErr.style.display = "none";
          elStatus.textContent = "En ligne ‚úÖ";

          // milestone animation (one-shot)
          if (data.milestoneJustHit) {
            root.classList.add("milestoneHit");
            setTimeout(() => root.classList.remove("milestoneHit"), 2500);
          }
        } catch (e) {
          elStatus.textContent = "Hors ligne ‚ùå";
          elErr.style.display = "block";
        }
      }

      refresh();
      setInterval(refresh, 5000);
    </script>
  </body>
</html>
