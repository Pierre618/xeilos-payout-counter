<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payouts Communaut√© Xeilos</title>
  <style>
    :root{
      --bg: rgba(0,0,0,0);
      --card: rgba(20,20,20,0.85);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.75);
      --track: rgba(255,255,255,0.18);
      --bar-fill: #C62828; /* üî¥ ton rouge */
      --shadow: rgba(0,0,0,0.35);
      --radius: 14px;
    }

    html, body{
      width: 100%;
      height: 100%;
      margin: 0;
      background: var(--bg);
      overflow: hidden;
    }

    /* Container */
    .root{
      position: relative;
      width: 800px;
      height: 120px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px var(--shadow);
      padding: 14px 16px;
      box-sizing: border-box;
      color: var(--text);
      overflow: hidden;
    }

    /* Header */
    .top{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .title{
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    /* ‚úÖ On ne montre plus ‚ÄúEn ligne‚Äù */
    .status{
      display: none !important;
    }

    /* Numbers line */
    .numbers{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 12px;
    }

    .leftNums{
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
    }

    .rightNums{
      font-weight: 700;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* Progress bar */
    .bar{
      width: 100%;
      height: 10px;
      background: var(--track);
      border-radius: 999px;
      overflow: hidden;
    }
    .fill{
      width: 0%;
      height: 100%;
      background: var(--bar-fill);
      border-radius: 999px;
      transition: width 600ms ease;
    }

    /* Footer */
    .footer{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .footerLeft{
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .footerRight{
      flex: 0 0 auto;
    }

    .err{
      position: absolute;
      left: 16px;
      bottom: 10px;
      font-size: 12px;
      color: #ffb4b4;
      display: none;
    }

    /* =========================
       üíµ MONEY RAIN ANIMATION
       ========================= */
    .money-layer{
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .bill{
      position: absolute;
      top: -40px;
      font-size: 22px;
      opacity: 0.95;
      filter: drop-shadow(0 6px 8px rgba(0,0,0,0.35));
      animation: fall linear forwards;
      will-change: transform, opacity;
      user-select: none;
    }

    @keyframes fall{
      0%   { transform: translate3d(0, -30px, 0) rotate(0deg); opacity: 0; }
      10%  { opacity: 1; }
      100% { transform: translate3d(var(--dx), 170px, 0) rotate(var(--rot)); opacity: 0; }
    }

    /* Petit flash ‚Äúmilestone‚Äù */
    .flash{
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.14), rgba(255,255,255,0));
      opacity: 0;
      pointer-events: none;
      animation: flash 900ms ease-out forwards;
    }
    @keyframes flash{
      0% { opacity: 0; }
      18% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>

<body>
  <div class="root" id="root">
    <div class="money-layer" id="money"></div>

    <div class="top">
      <div class="title">üí∞ Payouts Communaut√© Xeilos</div>
      <div class="status" id="status">En ligne ‚úÖ</div>
    </div>

    <div class="numbers">
      <div class="leftNums"><span id="cur">$0</span> / <span id="target">$100,000</span></div>
      <div class="rightNums" id="totalCumul">Total cumul : $0</div>
    </div>

    <div class="bar"><div class="fill" id="fill"></div></div>

    <div class="footer">
      <div class="footerLeft" id="last">Dernier payout : ‚Äî</div>
      <div class="footerRight" id="meta">‚Äî</div>
    </div>

    <div class="err" id="err">Erreur de connexion API</div>
  </div>

  <script>
    // üîß L‚ÄôAPI est servie par le m√™me domaine Railway
    const API_URL = "/payouts";

    const elCur = document.getElementById("cur");
    const elTarget = document.getElementById("target");
    const elFill = document.getElementById("fill");
    const elLast = document.getElementById("last");
    const elMeta = document.getElementById("meta");
    const elErr = document.getElementById("err");
    const elTotalCumul = document.getElementById("totalCumul");
    const moneyLayer = document.getElementById("money");
    const root = document.getElementById("root");

    function fmtUSD(n){
      const v = Number(n || 0);
      return v.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    }

    function timeAgo(ts){
      const t = Number(ts || 0);
      if (!t) return "‚Äî";
      const diff = Date.now() - t;
      if (diff < 10000) return "√† l‚Äôinstant";
      const s = Math.floor(diff / 1000);
      if (s < 60) return `il y a ${s}s`;
      const m = Math.floor(s / 60);
      if (m < 60) return `il y a ${m} min`;
      const h = Math.floor(m / 60);
      if (h < 24) return `il y a ${h}h`;
      const d = Math.floor(h / 24);
      return `il y a ${d}j`;
    }

    // =========================
    // üíµ Animation money rain
    // =========================
    function triggerMoneyRain(){
      // flash
      const flash = document.createElement("div");
      flash.className = "flash";
      root.appendChild(flash);
      setTimeout(() => flash.remove(), 1000);

      const symbols = ["üíµ","üí≤","$","üí∞","üíµ","üí≤"];
      const count = 26;           // quantit√© de "billets"
      const durationMin = 900;    // ms
      const durationMax = 1700;   // ms

      for (let i = 0; i < count; i++){
        const s = document.createElement("div");
        s.className = "bill";
        s.textContent = symbols[Math.floor(Math.random() * symbols.length)];

        const left = Math.random() * 100; // %
        const dx = (Math.random() * 220 - 110) + "px";
        const rot = (Math.random() * 380 - 190) + "deg";
        const dur = Math.floor(durationMin + Math.random() * (durationMax - durationMin));

        s.style.left = left + "%";
        s.style.setProperty("--dx", dx);
        s.style.setProperty("--rot", rot);
        s.style.animationDuration = dur + "ms";
        s.style.fontSize = (18 + Math.random() * 16) + "px";

        moneyLayer.appendChild(s);
        setTimeout(() => s.remove(), dur + 200);
      }
    }

    async function refresh(){
      try{
        elErr.style.display = "none";

        const res = await fetch(API_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const total = Number(data.total || 0);
        const step = Number(data.step || 100000);

        // Progress "cycle" (0->100k, puis reset visuel)
        const inStep = total % step;                // 0..99999
        const pct = Math.max(0, Math.min(100, (inStep / step) * 100));

        elCur.textContent = fmtUSD(inStep);
        elTarget.textContent = fmtUSD(step);
        elFill.style.width = pct.toFixed(2) + "%";

        elTotalCumul.textContent = "Total cumul : " + fmtUSD(total);

        // Dernier payout
        const lp = Number(data.lastPayout || 0);
        const ls = (data.lastStudent || "").trim();
        if (lp > 0){
          elLast.textContent = `Dernier payout : ${fmtUSD(lp)} ‚Ä¢ ${ls || "‚Äî"}`;
        } else {
          elLast.textContent = "Dernier payout : ‚Äî";
        }

        elMeta.textContent = timeAgo(data.lastAt);

        // ‚úÖ Animation au passage de palier (one-shot via API)
        if (data.milestoneJustHit){
          triggerMoneyRain();
        }

      } catch (e){
        elErr.style.display = "block";
      }
    }

    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
