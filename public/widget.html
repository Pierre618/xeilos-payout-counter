<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payouts Communaut√© Xeilos</title>
  <style>
    /* =========================================================
      üé® COULEURS FACILES A MODIFIER ICI
      (on ne touche pas √† la police comme demand√©)
    ========================================================= */
    :root{
      --card-bg: rgba(0,0,0,.55);
      --card-border: rgba(255,255,255,.10);

      --text: #ffffff;
      --muted: rgba(255,255,255,.75);

      --bar-bg: rgba(255,255,255,.14);
      --bar-fill: #ffffff;

      --shadow: 0 10px 35px rgba(0,0,0,.35);
    }

    /* Fond transparent pour Streamlabs */
    html, body {
      background: rgba(0,0,0,0);
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .root {
      width: 800px;            /* tu peux ajuster dans Streamlabs */
      border-radius: 12px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      color: var(--text);
      padding: 12px 14px;
      box-sizing: border-box;
    }

    .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .title {
      font-weight: 700;
      font-size: 18px;
      line-height: 1.1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚úÖ ON CACHE "EN LIGNE" */
    .status {
      display: none !important;
    }

    .line1 {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 6px;
    }

    .leftAmount {
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
    }

    .rightTotal {
      font-weight: 600;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    .bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: var(--bar-bg);
      overflow: hidden;
      position: relative;
    }

    .fill {
      height: 100%;
      width: 0%;
      background: var(--bar-fill);
      border-radius: 999px;
      transition: width .35s ease;
    }

    .bottom {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .err {
      margin-top: 8px;
      font-size: 12px;
      color: #ffb4b4;
      display: none;
    }
  </style>
</head>

<body>
  <div class="root" id="root">
    <div class="top">
      <div class="title">üí∞ Payouts Communaut√© Xeilos</div>
      <div class="status" id="status">En ligne ‚úÖ</div>
    </div>

    <div class="line1">
      <div class="leftAmount">
        <span id="currentInStep">$0</span> / <span id="stepAmount">$100,000</span>
      </div>
      <div class="rightTotal">
        Total cumul : <span id="totalAll">$0</span>
      </div>
    </div>

    <div class="bar">
      <div class="fill" id="fill"></div>
    </div>

    <div class="bottom">
      <div id="lastText">Dernier payout : ‚Äî</div>
      <div id="ageText">‚Äî</div>
    </div>

    <div class="err" id="err">Erreur de connexion API</div>
  </div>

  <script>
    // ‚úÖ L'API est servie par le m√™me domaine Railway
    const API_URL = `${window.location.origin}/payouts`;

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    }

    function timeAgo(ts){
      const t = Number(ts || 0);
      if (!t) return "‚Äî";
      const diff = Date.now() - t;
      if (diff < 10_000) return "√† l'instant";
      const s = Math.floor(diff / 1000);
      if (s < 60) return `il y a ${s}s`;
      const m = Math.floor(s / 60);
      if (m < 60) return `il y a ${m} min`;
      const h = Math.floor(m / 60);
      if (h < 24) return `il y a ${h} h`;
      const d = Math.floor(h / 24);
      return `il y a ${d} j`;
    }

    const elFill = document.getElementById("fill");
    const elCurrent = document.getElementById("currentInStep");
    const elStep = document.getElementById("stepAmount");
    const elTotal = document.getElementById("totalAll");
    const elLast = document.getElementById("lastText");
    const elAge = document.getElementById("ageText");
    const elErr = document.getElementById("err");
    const elStatus = document.getElementById("status");

    async function refresh(){
      try{
        elErr.style.display = "none";

        const res = await fetch(API_URL, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // data: { total, step, lastPayout, lastStudent, lastAt, milestone, milestoneJustHit }

        const total = Number(data.total || 0);
        const step = Number(data.step || 100000);

        // ‚úÖ barre = progression dans le cycle courant
        const inStep = total % step;

        elCurrent.textContent = money(inStep);
        elStep.textContent = money(step);
        elTotal.textContent = money(total);

        const pct = Math.max(0, Math.min(100, (inStep / step) * 100));
        elFill.style.width = pct.toFixed(2) + "%";

        const lp = Number(data.lastPayout || 0);
        const ls = (data.lastStudent || "").trim();
        if(lp > 0){
          elLast.textContent = `Dernier payout : ${money(lp)} ‚Ä¢ ${ls || "‚Äî"}`;
        } else {
          elLast.textContent = "Dernier payout : ‚Äî";
        }

        elAge.textContent = timeAgo(data.lastAt);

        // (status cach√© mais on le met quand m√™me √† jour)
        elStatus.textContent = "En ligne ‚úÖ";

      } catch(e){
        elStatus.textContent = "Hors ligne ‚ùå";
        elErr.style.display = "block";
      }
    }

    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
