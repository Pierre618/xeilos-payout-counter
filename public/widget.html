<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payouts CommunautÃ© Xeilos</title>

  <style>
    :root{
      --bg: rgba(0,0,0,0.70);
      --fg: #ffffff;
      --muted: rgba(255,255,255,0.72);

      --bar-bg: rgba(255,255,255,0.18);
      --bar-fill: #2FBF71; /* âœ… vert billet */

      --shadow: 0 10px 28px rgba(0,0,0,0.35);
      --radius: 14px;
      --pad: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; background:transparent; }
    body{
      font-family: Arial, sans-serif;
      color: var(--fg);
      overflow:hidden;
    }

    /* Container */
    .root{
      width: 800px;
      height: 120px;
      padding: var(--pad);
      background: var(--bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap: 10px;
      position: relative;
      overflow:hidden;
    }

    /* Top row */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      white-space:nowrap;
    }

    .title{
      font-weight: 700;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap: 8px;
      letter-spacing: 0.2px;
    }

    .total{
      font-weight: 700; /* âœ… gras comme le titre */
      font-size: 14px;
      color: var(--fg);
      opacity: 0.95;
    }

    /* Progress row */
    .mid{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size: 14px;
      color: var(--fg);
    }

    .bar{
      width:100%;
      height: 10px;
      border-radius: 999px;
      background: var(--bar-bg);
      overflow:hidden;
      position:relative;
    }

    .fill{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: var(--bar-fill);
      transition: width 650ms ease;
    }

    /* Bottom row */
    .bottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .last{
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Errors */
    .err{
      display:none;
      position:absolute;
      left: var(--pad);
      right: var(--pad);
      bottom: var(--pad);
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(220, 53, 69, 0.22);
      color: rgba(255,255,255,0.92);
      font-size: 12px;
    }

    /* ===================== ðŸ’¸ BILL RAIN (6s) ===================== */
    .fx{
      pointer-events:none;
      position:absolute;
      inset:0;
      overflow:hidden;
      opacity:0;
    }
    .fx.active{ opacity:1; }

    .bill{
      position:absolute;
      top:-90px;
      width: 70px;
      height: 36px;
      border-radius: 7px;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.16), rgba(255,255,255,0.02)),
        linear-gradient(0deg, rgba(0,0,0,0.10), rgba(0,0,0,0.00)),
        #2FBF71;
      box-shadow: 0 10px 18px rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.18);
      opacity: 0.95;
      will-change: transform, top, opacity;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(0,0,0,0.55);
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.5px;
    }
    .bill::after{ content:"$"; }

    @keyframes fall {
      0%   { transform: translateY(0) rotate(var(--rot0)); opacity: 0; }
      10%  { opacity: 0.95; }
      100% { transform: translateY(260px) rotate(var(--rot1)); opacity: 0.0; }
    }

    /* petite secousse Ã  100k */
    .root.hit{ animation: hit 450ms ease; }
    @keyframes hit{
      0%{ transform: translateY(0); }
      30%{ transform: translateY(-2px); }
      60%{ transform: translateY(1px); }
      100%{ transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="root" id="root">
    <div class="fx" id="fx"></div>

    <div class="top">
      <div class="title">ðŸ’° Payouts CommunautÃ© Xeilos</div>
      <div class="total" id="totalCumul">Total cumul : $0</div>
    </div>

    <div class="mid">
      <div class="line">
        <div><span id="current">$0</span> / <span id="target">$100,000</span></div>
      </div>

      <div class="bar">
        <div class="fill" id="fill"></div>
      </div>
    </div>

    <div class="bottom">
      <div class="last" id="lastLine">Dernier payout : â€”</div>
      <div id="ago">â€”</div>
    </div>

    <div class="err" id="err">Erreur de connexion API</div>

    <!-- ðŸ”Š Audio milestone -->
    <audio id="milestoneAudio" preload="auto" src="./cash.mp3"></audio>
  </div>

  <script>
    /* ================= CONFIG ================= */
    const API_URL = "/payouts";  // mÃªme domaine Railway
    const REFRESH_MS = 5000;
    const FX_DURATION_MS = 6000;
    const SOUND_URL = "./cash.mp3"; // âœ… ton fichier
    const BILL_COUNT = 34; // densitÃ© pluie

    /* ================= DOM ================= */
    const root = document.getElementById("root");
    const fx = document.getElementById("fx");
    const elCurrent = document.getElementById("current");
    const elTarget = document.getElementById("target");
    const elFill = document.getElementById("fill");
    const elLast = document.getElementById("lastLine");
    const elAgo = document.getElementById("ago");
    const elErr = document.getElementById("err");
    const elTotalCumul = document.getElementById("totalCumul");
    const audio = document.getElementById("milestoneAudio");

    audio.src = SOUND_URL;

    /* ================= HELPERS ================= */
    function fmtUSD(n){
      const v = Number(n || 0);
      return v.toLocaleString("en-US", { style:"currency", currency:"USD", maximumFractionDigits:0 });
    }

    function timeAgo(ts){
      if (!ts) return "â€”";
      const diff = Date.now() - Number(ts);
      if (diff < 10_000) return "Ã  lâ€™instant";
      const s = Math.floor(diff/1000);
      if (s < 60) return `il y a ${s}s`;
      const m = Math.floor(s/60);
      if (m < 60) return `il y a ${m} min`;
      const h = Math.floor(m/60);
      if (h < 24) return `il y a ${h} h`;
      const d = Math.floor(h/24);
      return `il y a ${d} j`;
    }

    function safeUsername(u){
      if (!u) return "";
      return String(u).replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    /* ================= FX: BILL RAIN ================= */
    let fxTimeout = null;

    function startBillRain(){
      // reset
      fx.innerHTML = "";
      fx.classList.add("active");
      root.classList.add("hit");

      // play sound (browser may block if never had interaction)
      try {
        audio.currentTime = 0;
        audio.volume = 1.0;
        audio.play().catch(()=>{ /* si bloquÃ©, tant pis */ });
      } catch(e){}

      // create bills
      const w = root.clientWidth;
      for (let i=0; i<BILL_COUNT; i++){
        const b = document.createElement("div");
        b.className = "bill";

        const left = Math.random() * (w - 70);
        const delay = Math.random() * 1200; // Ã©talÃ©
        const dur = 2200 + Math.random() * 2200;
        const rot0 = (-25 + Math.random()*50).toFixed(1) + "deg";
        const rot1 = (-120 + Math.random()*240).toFixed(1) + "deg";

        b.style.left = left + "px";
        b.style.setProperty("--rot0", rot0);
        b.style.setProperty("--rot1", rot1);
        b.style.animation = `fall ${dur}ms linear ${delay}ms forwards`;

        fx.appendChild(b);
      }

      // stop FX after 6s
      clearTimeout(fxTimeout);
      fxTimeout = setTimeout(()=>{
        fx.classList.remove("active");
        fx.innerHTML = "";
        root.classList.remove("hit");
      }, FX_DURATION_MS);
    }

    /* ================= STATE ================= */
    let lastMilestoneSeen = 0;

    async function refresh(){
      try{
        elErr.style.display = "none";

        const res = await fetch(API_URL, { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const total = Number(data.total || 0);
        const step = Number(data.step || 100000);

        // progress in current cycle
        const inStep = total % step;
        const pct = Math.max(0, Math.min(100, (inStep/step)*100));

        elCurrent.textContent = fmtUSD(inStep);
        elTarget.textContent = fmtUSD(step);
        elFill.style.width = pct.toFixed(2) + "%";

        // total cumul
        elTotalCumul.textContent = `Total cumul : ${fmtUSD(total)}`;

        // last payout line
        const lp = Number(data.lastPayout || 0);
        const ls = safeUsername(data.lastStudent || "");
        if (lp > 0){
          elLast.textContent = `Dernier payout : ${fmtUSD(lp)} â€¢ ${ls}`;
        } else {
          elLast.textContent = "Dernier payout : â€”";
        }
        elAgo.textContent = timeAgo(data.lastAt || 0);

        // milestone FX
        const milestone = Number(data.milestone || 0);
        const justHit = !!data.milestoneJustHit;

        // dÃ©clenchement : soit justHit, soit milestone augmente
        if (justHit || (milestone > 0 && milestone !== lastMilestoneSeen)){
          startBillRain();
        }
        lastMilestoneSeen = milestone;

      } catch(e){
        elErr.style.display = "block";
      }
    }

    // First refresh + interval
    refresh();
    setInterval(refresh, REFRESH_MS);

    // Optional: unlock audio on first click (utile si navigateur bloque autoplay)
    window.addEventListener("click", () => {
      try { audio.play().then(()=>audio.pause()).catch(()=>{}); } catch(e){}
    }, { once:true });
  </script>
</body>
</html>
