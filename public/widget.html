<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payouts Communaut√© Xeilos</title>
  <style>
    :root{
      --bg: rgba(0,0,0,0.65);
      --panel: rgba(20,20,20,0.85);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.75);
      --muted2: rgba(255,255,255,0.55);
      --barBg: rgba(255,255,255,0.12);
      --barFill: rgba(255,255,255,0.92);
      --ok: #4ade80;
      --err: #fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 10px;
      --pad: 12px;
      --w: 800px;
    }

    html,body{
      margin:0;
      padding:0;
      background: transparent;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
    }

    .root{
      width: var(--w);
      box-sizing: border-box;
      background: var(--bg);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .header{
      padding: var(--pad);
      background: var(--panel);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .title{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.2px;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }

    .status{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--err);
      box-shadow: 0 0 0 3px rgba(251,113,133,0.18);
      flex: 0 0 auto;
    }
    .dot.ok{
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(74,222,128,0.18);
    }

    .content{
      padding: var(--pad);
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .line1{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      font-weight: 700;
    }
    .progressText{
      font-size: 14px;
      color: var(--text);
      white-space: nowrap;
    }
    .totalText{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .bar{
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: var(--barBg);
      overflow:hidden;
      position: relative;
    }
    .fill{
      height: 100%;
      width: 0%;
      background: var(--barFill);
      border-radius: 999px;
      transition: width 0.6s ease;
    }

    .line2{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted2);
    }
    .last{
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }
    .time{
      white-space: nowrap;
    }

    .error{
      display:none;
      padding: 8px 12px;
      background: rgba(251,113,133,0.12);
      border: 1px solid rgba(251,113,133,0.25);
      color: rgba(255,255,255,0.9);
      border-radius: 10px;
      font-size: 12px;
    }

    /* Flash animation quand un milestone est atteint */
    .milestoneHit .rootFlash{
      animation: flash 2.2s ease;
    }
    @keyframes flash{
      0%{ filter: brightness(1); }
      12%{ filter: brightness(1.25); }
      25%{ filter: brightness(1.05); }
      40%{ filter: brightness(1.20); }
      100%{ filter: brightness(1); }
    }

    .rootFlash{
      border-radius: var(--radius);
    }
  </style>
</head>

<body>
  <div id="root" class="rootFlash">
    <div class="root">
      <div class="header">
        <div class="title">üí∞ Payouts Communaut√© Xeilos</div>
        <div class="status"><span id="dot" class="dot"></span><span id="statusText">Hors ligne</span></div>
      </div>

      <div class="content">
        <div class="line1">
          <div class="progressText"><span id="cycleCurrent">$0</span> / <span id="cycleTarget">$100,000</span></div>
          <div id="totalGlobal" class="totalText">Total cumul : $0</div>
        </div>

        <div class="bar"><div id="fill" class="fill"></div></div>

        <div class="line2">
          <div id="lastLine" class="last">Dernier payout : ‚Äî</div>
          <div id="timeAgo" class="time">‚Äî</div>
        </div>

        <div id="errBox" class="error">Erreur de connexion API</div>
      </div>
    </div>
  </div>

  <script>
    // ‚öôÔ∏è IMPORTANT : ton API est servie sur le m√™me domaine Railway
    // Donc on peut utiliser un chemin relatif => pas de CORS, pas d‚Äôerreurs.
    const API_URL = "/payouts";

    const elDot = document.getElementById("dot");
    const elStatus = document.getElementById("statusText");
    const elCycleCurrent = document.getElementById("cycleCurrent");
    const elCycleTarget = document.getElementById("cycleTarget");
    const elFill = document.getElementById("fill");
    const elLast = document.getElementById("lastLine");
    const elTime = document.getElementById("timeAgo");
    const elErr = document.getElementById("errBox");
    const elTotalGlobal = document.getElementById("totalGlobal");
    const root = document.getElementById("root");

    function fmtUSD(n){
      const v = Number(n || 0);
      return v.toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    }

    function timeAgo(ts){
      const t = Number(ts || 0);
      if(!t) return "‚Äî";
      const diff = Date.now() - t;
      if(diff < 0) return "‚Äî";
      const s = Math.floor(diff / 1000);
      if(s < 10) return "√† l‚Äôinstant";
      if(s < 60) return "il y a " + s + "s";
      const m = Math.floor(s / 60);
      if(m < 60) return "il y a " + m + " min";
      const h = Math.floor(m / 60);
      if(h < 24) return "il y a " + h + "h";
      const d = Math.floor(h / 24);
      return "il y a " + d + "j";
    }

    async function refresh(){
      try{
        const res = await fetch(API_URL, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        // --- ONLINE UI
        elDot.classList.add("ok");
        elStatus.textContent = "En ligne ‚úÖ";
        elErr.style.display = "none";

        const total = Number(data.total || 0);
        const step = Number(data.step || 100000);

        // ‚úÖ Cycle logic : barre repart tous les 100k, total reste cumulatif
        const cycleIndex = Math.floor(total / step);      // 0,1,2,3...
        const cycleStart = cycleIndex * step;             // 0,100k,200k...
        const cycleProgress = total - cycleStart;         // 0..step-1 (ou step)
        const pct = Math.max(0, Math.min(100, (cycleProgress / step) * 100));

        elCycleCurrent.textContent = fmtUSD(cycleProgress);
        elCycleTarget.textContent  = fmtUSD(step);
        elFill.style.width = pct.toFixed(2) + "%";

        // Total cumulatif affich√© √† part
        elTotalGlobal.textContent = "Total cumul : " + fmtUSD(total);

        // Dernier payout valid√©
        const lp = Number(data.lastPayout || 0);
        const ls = String(data.lastStudent || "").trim();

        if(lp > 0 && ls){
          elLast.textContent = "Dernier payout : " + fmtUSD(lp) + " ‚Ä¢ " + ls;
        } else {
          elLast.textContent = "Dernier payout : ‚Äî";
        }
        elTime.textContent = timeAgo(data.lastAt);

        // Animation milestone (100k,200k,300k...)
        if(data.milestoneJustHit){
          root.classList.add("milestoneHit");
          setTimeout(() => root.classList.remove("milestoneHit"), 2500);
        }

      } catch(e){
        // --- OFFLINE UI
        elDot.classList.remove("ok");
        elStatus.textContent = "Hors ligne ‚ùå";
        elErr.style.display = "block";
      }
    }

    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
